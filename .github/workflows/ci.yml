name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Install GNAT and Alire
        run: |
          sudo apt-get update
          sudo apt-get install -y gnat gprbuild
          # Install Alire
          wget -q https://github.com/alire-project/alire/releases/download/v2.0.1/alr-2.0.1-bin-x86_64-linux.zip
          unzip -q alr-2.0.1-bin-x86_64-linux.zip
          sudo mv bin/alr /usr/local/bin/
          rm -rf bin alr-2.0.1-bin-x86_64-linux.zip

      - name: Install ncurses development libraries
        run: sudo apt-get install -y libncurses-dev

      - name: Build
        working-directory: src
        run: |
          alr --non-interactive build

      - name: Run tests
        working-directory: src
        run: |
          ./bin/nano_aida --test

  spark-prove:
    runs-on: ubuntu-latest
    continue-on-error: true  # SPARK proof is advisory for now

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Install GNAT and SPARK
        run: |
          sudo apt-get update
          sudo apt-get install -y gnat gprbuild spark2014

      - name: Install ncurses development libraries
        run: sudo apt-get install -y libncurses-dev

      - name: Run SPARK prover
        working-directory: src
        run: |
          gnatprove -P nano_aida.gpr --level=1 --warnings=continue || echo "SPARK proof completed with warnings"
